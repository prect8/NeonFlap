<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Flap - The Lovable Kusoge</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #111;
            font-family: 'Courier New', Courier, monospace;
            touch-action: none;
            /* スマホでのスクロール防止 */
        }

        canvas {
            display: block;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
        }

        h1 {
            font-size: 4rem;
            margin: 0;
            color: #ff00ff;
            text-shadow: 4px 4px 0 #00ffff;
            animation: pulse 1s infinite alternate;
        }

        p {
            font-size: 1.5rem;
            margin-top: 10px;
        }

        .score-display {
            position: absolute;
            top: 20px;
            font-size: 3rem;
            font-weight: bold;
            z-index: 10;
            color: #fff;
        }

        @keyframes pulse {
            from {
                transform: scale(1);
            }

            to {
                transform: scale(1.05);
            }
        }

        #debug {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: #555;
            font-size: 10px;
        }
    </style>
</head>

<body>

    <div id="ui-layer">
        <div id="start-screen">
            <h1>NEON FLAP</h1>
            <p>CLICK / TAP TO START</p>
            <p style="font-size: 0.8rem; color: #aaa;">愛すべきクソゲーへようこそ</p>
        </div>
        <div id="game-over-screen" style="display: none;">
            <h1 style="color: #ff3333; text-shadow: 4px 4px 0 #aa0000;">GAME OVER</h1>
            <p id="final-score">SCORE: 0</p>
            <p id="insult-msg">TRY AGAIN?</p>
            <p style="font-size: 1rem; margin-top: 20px; animation: blink 0.5s infinite;">CLICK TO RESTART</p>
        </div>
    </div>

    <div class="score-display" id="score-counter" style="display:none;">0</div>
    <div id="debug">FPS: 60</div>

    <canvas id="gameCanvas"></canvas>

    <script>
        // --- 設定と定数 ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d', { alpha: false }); // 高速化のためalpha false

        // ゲームステート
        let gameState = 'START'; // START, PLAYING, GAMEOVER
        let frames = 0;
        let score = 0;
        let highScore = localStorage.getItem('neonFlapHighScore') || 0;
        let gameSpeed = 3.5; // 初期の速さ

        // 物理演算
        const gravity = 0.25;
        const jumpStrength = -6.5; // ジャンプ力

        // エンティティ
        let bird = {
            x: 50,
            y: 150,
            w: 24,
            h: 24,
            dy: 0,
            angle: 0,
            color: '#ffff00'
        };

        let pipes = [];
        let particles = [];

        // UI要素
        const uiStart = document.getElementById('start-screen');
        const uiGameOver = document.getElementById('game-over-screen');
        const scoreCounter = document.getElementById('score-counter');
        const finalScore = document.getElementById('final-score');
        const insultMsg = document.getElementById('insult-msg');
        const fpsDisplay = document.getElementById('debug');

        // クソゲー的煽りメッセージ
        const messages = [
            "重力に負けた？",
            "もう諦めるの？",
            "指が滑っただけだよね",
            "床はおいしい？",
            "鳥になりたかった...",
            "反射神経...あれ？",
            "今の本気？"
        ];

        // --- オーディオ (Web Audio API) ---
        // クソゲーらしいピコピコ音を生成
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new AudioContext();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playSound(type) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const now = audioCtx.currentTime;

            if (type === 'jump') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.exponentialRampToValueAtTime(600, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'score') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1000, now);
                osc.frequency.setValueAtTime(1500, now + 0.05);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'die') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(200, now);
                osc.frequency.linearRampToValueAtTime(50, now + 0.3);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            }
        }

        // --- ゲームループ関連 ---

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            // 画面サイズが変わっても鳥の位置がある程度見えるように調整
            if (bird.y > canvas.height) bird.y = canvas.height - 50;
        }
        window.addEventListener('resize', resize);
        resize();

        function resetGame() {
            bird = {
                x: canvas.width * 0.15, // 左から15%の位置
                y: canvas.height / 2,
                w: 24,
                h: 24,
                dy: 0,
                angle: 0,
                color: '#ffff00'
            };
            pipes = [];
            particles = [];
            score = 0;
            frames = 0;
            gameSpeed = 3.5; // リセット
            scoreCounter.innerText = score;
            gameState = 'PLAYING';

            uiStart.style.display = 'none';
            uiGameOver.style.display = 'none';
            scoreCounter.style.display = 'block';
        }

        function createParticles(x, y, color) {
            for (let i = 0; i < 8; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 8,
                    vy: (Math.random() - 0.5) * 8,
                    life: 1.0,
                    color: color
                });
            }
        }

        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.05;
                if (p.life <= 0) {
                    particles.splice(i, 1);
                }
            }
        }

        function drawParticles() {
            for (let p of particles) {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, 4, 4);
                ctx.globalAlpha = 1.0;
            }
        }

        function gameOver() {
            gameState = 'GAMEOVER';
            playSound('die');
            createParticles(bird.x, bird.y, '#ff0000');

            // UI更新
            scoreCounter.style.display = 'none';
            uiGameOver.style.display = 'flex';
            finalScore.innerText = `SCORE: ${score} (HI: ${Math.max(score, highScore)})`;
            insultMsg.innerText = messages[Math.floor(Math.random() * messages.length)];

            if (score > highScore) {
                highScore = score;
                localStorage.setItem('neonFlapHighScore', highScore);
                insultMsg.innerText = "NEW RECORD! (やるじゃん)";
                insultMsg.style.color = "#ffff00";
            } else {
                insultMsg.style.color = "#fff";
            }
        }

        function update() {
            if (gameState !== 'PLAYING') return;

            frames++;

            // 難易度上昇（速度アップ）
            if (frames % 600 === 0) {
                gameSpeed += 0.2;
            }

            // 鳥の物理
            bird.dy += gravity;
            bird.y += bird.dy;

            // 回転演出
            bird.angle = Math.min(Math.PI / 4, Math.max(-Math.PI / 4, (bird.dy * 0.1)));

            // 床・天井判定
            if (bird.y + bird.h >= canvas.height || bird.y <= 0) {
                gameOver();
            }

            // 土管生成
            // 画面幅に応じて生成頻度を変える（レスポンシブ対応）
            const pipeInterval = Math.floor(2500 / (gameSpeed * 10)); // 適当な調整
            if (frames % 90 === 0) { // 固定フレームで生成
                const gap = 160; // 隙間の広さ
                const minHeight = 50;
                const maxPos = canvas.height - gap - minHeight;
                const topHeight = Math.floor(Math.random() * (maxPos - minHeight + 1) + minHeight);

                pipes.push({
                    x: canvas.width,
                    y: 0,
                    w: 60,
                    h: topHeight,
                    passed: false,
                    type: 'top'
                });

                pipes.push({
                    x: canvas.width,
                    y: topHeight + gap,
                    w: 60,
                    h: canvas.height - (topHeight + gap),
                    passed: false,
                    type: 'bottom'
                });
            }

            // 土管の移動と判定
            for (let i = 0; i < pipes.length; i++) {
                let p = pipes[i];
                p.x -= gameSpeed;

                // 当たり判定 (AABB)
                // 少し甘めの判定にして「クソゲー」の理不尽さを減らす（優しさ）
                const hitboxPadding = 4;
                if (
                    bird.x + hitboxPadding < p.x + p.w &&
                    bird.x + bird.w - hitboxPadding > p.x &&
                    bird.y + hitboxPadding < p.y + p.h &&
                    bird.y + bird.h - hitboxPadding > p.y
                ) {
                    gameOver();
                }

                // スコア加算 (上側の土管を通過したときのみ判定)
                if (p.type === 'top' && p.x + p.w < bird.x && !p.passed) {
                    score++;
                    scoreCounter.innerText = score;
                    p.passed = true;
                    playSound('score');
                    // 10点ごとにパーティクル演出
                    if (score % 10 === 0) createParticles(bird.x, bird.y, '#00ffff');
                }
            }

            // 画面外の土管削除
            if (pipes.length > 0 && pipes[0].x < -100) {
                pipes.shift();
            }

            updateParticles();
        }

        function draw() {
            // 背景クリア (残像効果のために少し透明な黒を重ねる)
            // クソゲーっぽさを出すために残像を少し残す
            ctx.fillStyle = 'rgba(17, 17, 17, 1.0)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 床のガイドライン
            ctx.strokeStyle = '#333';
            ctx.beginPath();
            ctx.moveTo(0, canvas.height - 10);
            ctx.lineTo(canvas.width, canvas.height - 10);
            ctx.stroke();

            // 土管描画
            ctx.fillStyle = '#00ff00';
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#00ff00';
            for (let p of pipes) {
                ctx.fillRect(p.x, p.y, p.w, p.h);
                // 立体感を出すハイライト
                ctx.fillStyle = '#ccffcc';
                ctx.fillRect(p.x, p.y, 5, p.h);
                ctx.fillStyle = '#00ff00';
            }
            ctx.shadowBlur = 0;

            // プレイヤー描画
            if (gameState === 'PLAYING' || gameState === 'START' || gameState === 'GAMEOVER') {
                ctx.save();
                ctx.translate(bird.x + bird.w / 2, bird.y + bird.h / 2);
                ctx.rotate(bird.angle);

                // 本体
                ctx.fillStyle = bird.color;
                ctx.shadowBlur = 15;
                ctx.shadowColor = '#ffff00';
                ctx.fillRect(-bird.w / 2, -bird.h / 2, bird.w, bird.h);

                // 目 (クソゲーっぽい虚無な目)
                ctx.fillStyle = '#000';
                ctx.shadowBlur = 0;
                ctx.fillRect(2, -8, 6, 6); // 右目

                // 翼？
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(-8, 2, 8, 4);

                ctx.restore();
            }

            drawParticles();

            // FPSカウンタ更新 (簡易的)
            // fpsDisplay.innerText = `Entities: ${pipes.length + particles.length}`;
        }

        function loop() {
            update();
            draw();
            requestAnimationFrame(loop);
        }

        // --- 入力処理 ---

        function handleInput(e) {
            if (e.type === 'keydown' && e.code !== 'Space') return;
            if (e.type !== 'keydown') e.preventDefault(); // タッチ時のスクロール防止など

            initAudio();

            if (gameState === 'START') {
                resetGame();
            } else if (gameState === 'PLAYING') {
                bird.dy = jumpStrength;
                playSound('jump');
                // ジャンプ時のエフェクト
                createParticles(bird.x, bird.y + bird.h, '#ffffff');
            } else if (gameState === 'GAMEOVER') {
                // 少しウェイトを置いて連打による誤爆防止
                // (今回は即リスタートOKのサクサク仕様にする)
                resetGame();
            }
        }

        window.addEventListener('keydown', handleInput);
        window.addEventListener('touchstart', handleInput, { passive: false });
        window.addEventListener('mousedown', handleInput);

        // ゲーム開始待機
        loop();

    </script>
</body>

</html>